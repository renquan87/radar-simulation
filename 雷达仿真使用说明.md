# RM雷达站激光雷达仿真使用说明

## 概述

本仿真系统在 Ignition Gazebo (Fortress) 中模拟 RoboMaster 2026 赛场环境，用于开发空中机器人定位点云聚类算法。

### 主要组件

- **RMUC2026 赛场地图**（STL 导入，已校正尺寸 ~29m × 16m，地面在 Z=0）
- **红蓝双方各 3 个机器人**，站在赛场地面上
- **雷达站**（按规则手册 V1.3.0），搭载：
  - **Livox HAP 激光雷达**（GPU Lidar 仿真，120°×25° FOV，38400 pts/帧 @10Hz）
  - **工业相机**（1280×1024，FOV ~69°，30Hz）
- 通过 `ros_gz_bridge` 将传感器数据桥接到标准 **ROS2 话题**
- 发布完整的 **TF 坐标变换树**
- **参数调整工具**：修改配置文件即可重新生成世界

### 系统架构

```
┌───────────────────────────────────────────────────────┐
│  Ignition Gazebo (Fortress)                           │
│  ┌─────────────────┐  ┌───────────────────────────┐   │
│  │  RMUC2026 赛场   │  │ 雷达站 (radar_station)    │   │
│  │  + 6个机器人     │  │  ├─ Livox HAP (gpu_lidar) │   │
│  │                  │  │  └─ 工业相机 (camera)     │   │
│  └─────────────────┘  └───────────┬───────────────┘   │
│                                    │ Ignition Topics   │
└────────────────────────────────────┼───────────────────┘
                                     │
                          ┌──────────▼──────────┐
                          │   ros_gz_bridge      │
                          └──────────┬──────────┘
                                     │ ROS2 Topics
                    ┌────────────────┼────────────────┐
                    │                │                │
           /livox/lidar/points  /radar/camera/  /tf_static
           (PointCloud2)       image & info    (TF变换)
                    │                │                │
                    ▼                ▼                ▼
              ┌──────────────────────────────────────────┐
              │        你的算法节点 (如点云聚类)          │
              │   air_target_radar / HITS-radar-2024     │
              └──────────────────────────────────────────┘
```

## 环境要求

| 项目 | 版本 |
|------|------|
| 操作系统 | Ubuntu 22.04 |
| ROS2 | Humble |
| Gazebo | Ignition Fortress |
| 显卡 | 支持 OpenGL 3.3+（GPU Lidar 需要） |

## 快速开始

### 1. 安装依赖

```bash
sudo apt-get install -y \
  ignition-fortress \
  ros-humble-ros-gz \
  ros-humble-ros-gz-bridge \
  ros-humble-ros-gz-sim \
  ros-humble-ros-gz-image \
  ros-humble-tf2-ros
```

### 2. 编译

```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source /opt/ros/humble/setup.bash
rosdep install -y -r -q --from-paths src --ignore-src --rosdistro humble
colcon build --symlink-install
source install/setup.bash
```

### 3. 一键启动

```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source /opt/ros/humble/setup.bash
source install/setup.bash
ros2 launch radar_sim radar_sim.launch.py
```

#### 启动参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `use_rviz` | `true` | 是否自动打开 RViz2 |
| `world_name` | `rmuc2026_radar_sim` | Gazebo 世界名称 |

```bash
# 不启动 RViz (节省资源)
ros2 launch radar_sim radar_sim.launch.py use_rviz:=false

# 仅启动 Gazebo (调试用)
ign gazebo -r src/rmoss_gazebo/worlds/rmuc2026_radar_sim.sdf
```

## 赛场布局 (V1.3.0)

```
              Y轴 ↑
                  |
                  |     赛场范围 ~29m × 16m
    ┌─────────────┼─────────────────────────────┐ Y≈+8
    │  B1         │                         R1  │
    │(-10,+3)     │                    (+10,-3) │
    │             │                             │
    │      B2     │                  R2         │
    │   (-3,-2)   │              (+3,+2)        │
    │             │                             │
    │  B3         │                         R3  │
    │(-7,-5)      │                    (+7,+5)  │
    └─────────────┼─────────────────────────────┘ Y≈-8
 X≈-14.5          └──────────────────────→ X轴     X≈+14.5
    │
    ▼
  ┌─────┐
  │雷达站│  (-14.5, 0, 0) 面向+X
  │3.4×  │  平台高 2.5m
  │1.16m │  LiDAR 高 3.70m
  └─────┘  Camera 高 3.78m
```

### 雷达站参数 (规则手册 V1.3.0)

| 参数 | 值 | 说明 |
|------|-----|------|
| 世界位置 | (-14.5, 0, 0) | 蓝方宽边(X方向)边缘中心 |
| 朝向 | yaw = 0 | 面向 +X (赛场方向) |
| 平台尺寸 | 3.4m × 1.16m | 规则手册规定 |
| 平台高度 | 2.5m | 距地面 |
| 围栏高度 | 1.1m | 平台边缘 |
| LiDAR 高度 | 3.70m | 三脚架顶部 |
| Camera 高度 | 3.78m | LiDAR 正上方 |
| 传感器俯角 | 20° (0.35 rad) | 向下覆盖赛场 |

### Livox HAP 传感器参数

| 参数 | 仿真值 | 真实 HAP 值 |
|------|--------|-------------|
| 水平 FOV | 120° | 120° |
| 垂直 FOV | 25° | 25° |
| 探测范围 | 0.2-150m | 0.2-150m |
| 扫描频率 | 10 Hz | 10 Hz |
| 水平采样 | 600 samples | 非重复扫描模式 |
| 垂直采样 | 64 layers | 非重复扫描模式 |
| 每帧点数 | ~38,400 | ~45,300 |
| 噪声 | 高斯 σ=0.01m | ~0.01m |

> **注意**: 仿真使用固定扫描模式，真实 HAP 使用非重复扫描。对点云聚类算法开发已足够。

### 工业相机参数

| 参数 | 值 |
|------|-----|
| 分辨率 | 1280 × 1024 |
| FOV | ~69° (1.2 rad) |
| FPS | 30 |
| 格式 | RGB8 |
| 噪声 | 高斯 σ=0.007 |

## ROS2 话题说明

### 传感器数据

| 话题 | 类型 | 频率 | 说明 |
|------|------|------|------|
| `/livox/lidar/points` | `sensor_msgs/PointCloud2` | 10 Hz | Livox HAP 点云 |
| `/radar/camera/image` | `sensor_msgs/Image` | 30 Hz | 工业相机 RGB 图像 |
| `/radar/camera/camera_info` | `sensor_msgs/CameraInfo` | 30 Hz | 相机内参 |

### TF 坐标变换

| 父坐标系 | 子坐标系 | 说明 |
|----------|----------|------|
| `world` | `radar_station_base` | 雷达站底座 (-14.5, 0, 0) |
| `world` | `radar_station_blue::livox_hap::livox_hap_lidar` | LiDAR (Ignition frame_id) |
| `world` | `radar_station_blue::camera_link::radar_camera` | Camera (Ignition frame_id) |
| 上述 scoped frame | `livox_hap_lidar` | 简短别名 (方便算法使用) |
| 上述 scoped frame | `radar_camera` | 简短别名 |

> **关于 frame_id**: Ignition Gazebo 中传感器的 frame_id 为 scoped name 格式 (包含 `::`)。
> launch 文件同时发布了简短别名 TF，算法代码可使用 `livox_hap_lidar` 或 `radar_camera`。

### 验证数据

```bash
# 查看所有话题
ros2 topic list

# 查看点云频率
ros2 topic hz /livox/lidar/points

# 查看点云数据
ros2 topic echo /livox/lidar/points --once

# 查看相机图像
ros2 topic echo /radar/camera/image --once | head -10

# 查看 TF 树
ros2 run tf2_tools view_frames

# 查看 Ignition 内部话题 (调试用)
ign topic -l
ign topic -e -t /livox/lidar/points
```

## 参数调整工具

### 使用方法

不再需要手动编辑 SDF 文件！修改 Python 配置即可重新生成世界：

```bash
cd /data/projects/radar/simulation/ros2_simu_ws/src/radar_sim/config

# 1. 查看当前配置
python3 sim_config.py

# 2. 编辑 sim_config.py 中的参数 (机器人位置/雷达参数/物理引擎等)
# 例如修改 ROBOTS 列表中的坐标, 或 RADAR_STATION 的位置

# 3. 重新生成世界文件
python3 generate_world.py

# 4. 重新编译 (symlink-install 模式下通常不需要)
cd /data/projects/radar/simulation/ros2_simu_ws
colcon build --packages-select rmoss_gazebo radar_sim --symlink-install

# 5. 重新启动仿真
ros2 launch radar_sim radar_sim.launch.py
```

### 配置文件说明 (`sim_config.py`)

| 配置项 | 说明 |
|--------|------|
| `FIELD` | 赛场模型路径和偏移 |
| `RADAR_STATION` | 雷达站位置/朝向/传感器相对偏移 |
| `ROBOTS` | 所有机器人的位置列表 (可增删改) |
| `PHYSICS` | 物理引擎参数 (步长/实时因子) |
| `GUI_CAMERA` | Gazebo 默认相机视角 |

### 常用调整示例

```python
# sim_config.py 中修改雷达站位置 (例如移到红方侧)
RADAR_STATION = {
    "x": 14.5,     # 改为正X (红方侧)
    "y": 0.0,
    "z": 0.0,
    "yaw": 3.14,   # 面向-X (面向赛场)
    ...
}

# 添加新机器人
ROBOTS.append({
    "name": "blue_robot_4",
    "model_uri": "model://rmua19_standard_robot",
    "x": -5.0, "y": 0.0, "z": 0.0,
    "roll": 0, "pitch": 0, "yaw": 0,
    "team": "blue", "comment": "中路",
})
```

## 与算法项目对接

### 对接 air_target_radar 项目

```bash
# 终端1: 启动仿真
ros2 launch radar_sim radar_sim.launch.py use_rviz:=false

# 终端2: 启动点云处理节点
ros2 launch air_target_clustering clustering.launch.py \
  lidar_topic:=/livox/lidar/points \
  use_sim_time:=true
```

### 对接 HITS-radar 项目

```bash
ros2 run pc_detector pc_detector_node \
  --ros-args \
  -p use_sim_time:=true \
  -r /livox/lidar:=/livox/lidar/points
```

## 文件结构

```
ros2_simu_ws/
├── 雷达仿真使用说明.md              # 本文件
├── src/
│   ├── radar_sim/                   # 雷达仿真启动包
│   │   ├── CMakeLists.txt
│   │   ├── package.xml
│   │   ├── launch/
│   │   │   └── radar_sim.launch.py  # 一键启动 (Gazebo+Bridge+TF+RViz)
│   │   ├── rviz/
│   │   │   └── radar_sim.rviz       # RViz2 配置
│   │   └── config/
│   │       ├── sim_config.py        # 参数配置文件
│   │       └── generate_world.py    # 世界文件生成器
│   │
│   ├── rmoss_gazebo/
│   │   └── worlds/
│   │       └── rmuc2026_radar_sim.sdf  # 完整雷达仿真世界
│   │
│   └── rmoss_gz_resources/
│       └── resource/models/
│           ├── rmuc2026_competition/   # 赛场地图 (STL, scale 0.001)
│           ├── radar_station/          # 雷达站模型 (V1.3.0)
│           └── rmua19_standard_robot/  # 标准机器人模型
```

## 故障排除

### Q: RViz 中看不到点云
1. 检查 Fixed Frame 是否为 `world`
2. 确认 `/livox/lidar/points` 话题有数据: `ros2 topic hz /livox/lidar/points`
3. 检查 TF 是否正常: `ros2 topic echo /tf_static --once`
4. 检查 PointCloud2 的 Reliability Policy 是否为 `Best Effort`
5. ros_gz_bridge 有 5 秒延迟启动，请等待

### Q: `libEGL warning: egl: failed to create dri2 screen`
正常的 EGL 警告，不影响仿真。如果画面无法渲染：
```bash
export LIBGL_ALWAYS_SOFTWARE=1
```

### Q: 赛场地图显示异常（太大/太小）
检查 `rmuc2026_competition/model.sdf` 中 `<scale>` 是否为 `0.001 0.001 0.001`。

### Q: 机器人悬空或陷入地面
机器人模型内部已有 z=0.15 偏移。世界文件中 include pose 的 z 应为 0。

### Q: Gazebo 启动慢 / GPU Lidar 不工作
确保有 GPU 且驱动正常：
```bash
glxinfo | grep "OpenGL renderer"
# 应该显示你的 GPU 型号, 而非 llvmpipe
```

### Q: 想调整视角
在 Gazebo 中: 右键拖动旋转 / 中键滚轮缩放 / Shift+中键平移。
或修改 `sim_config.py` 中的 `GUI_CAMERA` 参数后重新生成世界文件。
