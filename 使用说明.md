# RMOSS Gazebo 仿真项目使用说明

## 项目概述

RMOSS Gazebo 是一个面向 RoboMaster 机器人的 ROS2 Gazebo 仿真项目，为 RoboMaster 机器人软件开发提供快速、灵活的开发工具，支持算法原型研究和 RoboMaster 比赛应用开发。

## 环境要求

- **操作系统**: Linux (推荐 Ubuntu 22.04)
- **ROS2 版本**: Humble
- **Gazebo 版本**: Fortress (新版 Gazebo)
- **Python 版本**: 3.10+

## 安装步骤

### 1. 安装系统依赖

```bash
# 安装 Gazebo 相关依赖
sudo apt-get install ignition-fortress libignition-cmake2-dev ros-humble-ros-gz
```

### 2. 克隆项目源码

```bash
# 进入 ROS2 工作空间的 src 目录
cd /data/projects/radar/simulation/ros2_simu_ws/src

# 克隆主要项目
git clone https://github.com/robomaster-oss/rmoss_gazebo.git -b humble
git clone https://github.com/robomaster-oss/rmoss_interfaces.git -b humble
git clone https://github.com/robomaster-oss/rmoss_gz_resources.git -b humble --depth=1
```

### 3. 编译项目

```bash
# 返回工作空间根目录
cd /data/projects/radar/simulation/ros2_simu_ws

# 安装 ROS 依赖
rosdep install -y -r -q --from-paths src --ignore-src --rosdistro humble

# 编译项目
colcon build
```

### 4. 设置环境

```bash
# 加载 ROS2 和项目环境
source install/setup.bash

# 建议将此命令添加到 ~/.bashrc 文件中
echo "source /data/projects/radar/simulation/ros2_simu_ws/install/setup.bash" >> ~/.bashrc
```

## 项目结构

### 主要功能模块

| 模块 | 功能说明 |
|------|----------|
| `rmoss_gz_plugins` | RoboMaster 相关 Gazebo Simulator 插件 |
| `rmoss_gz_base` | Gazebo 机器人基本接口，模拟 MCU 部分功能 |
| `rmoss_gz_cam` | Gazebo 相机接口 |
| `rmoss_gz_resources` | RoboMaster 相关核心 SDF 模型资源，官方机器人模型和核心场地模型 |

## 使用方法

### 1. 基础仿真启动

#### 1.1 启动机器人基础节点

```bash
# 确保环境已加载
source install/setup.bash

# 启动机器人基础节点
ros2 run rmoss_gz_base rmua19_robot_base

# 在另一个终端启动 Gazebo 仿真环境
ign gazebo /path/to/world_file.sdf
```

#### 1.2 使用预定义仿真场景

项目提供了几个测试场景：

```bash
# 启动射击测试场景
ign gazebo src/rmoss_gazebo/rmoss_gz_plugins/test/worlds/projectile_shooter.sdf

# 启动裁判系统测试场景
ign gazebo src/rmoss_gz_resources/test/rm21_referee_system.sdf
```

### 2. 使用测试脚本控制机器人

项目提供了多个测试脚本来控制机器人的不同部分：

#### 2.1 底盘控制测试

```bash
# 启动底盘控制测试脚本
ros2 run rmoss_gz_base test_chassis_cmd.py
```

**控制说明：**
- `w` - 前进
- `s` - 后退  
- `a` - 左移
- `d` - 右移
- `[` - 左转
- `]` - 右转
- `空格` - 停止
- `z` - 速度控制模式
- `x` - 跟随云台模式
- `Ctrl+C` - 退出

**参数设置：**
```bash
# 可以设置速度参数
ros2 run rmoss_gz_base test_chassis_cmd.py --ros-args -p v:=1.0 -p w:=1.0
```

#### 2.2 云台控制测试

```bash
# 启动云台控制测试脚本
ros2 run rmoss_gz_base test_gimbal_cmd.py
```

**控制说明：**
- `w` - 俯仰角向上
- `s` - 俯仰角向下
- `a` - 偏航角向左
- `d` - 偏航角向右
- `[` - 减小调整步长
- `]` - 增大调整步长
- `Ctrl+C` - 退出

#### 2.3 射击控制测试

```bash
# 启动射击控制测试脚本
ros2 run rmoss_gz_base test_shoot_cmd.py
```

**使用说明：**
- 输入要发射的弹丸数量
- 输入 `0` 或直接按回车退出

### 3. 机器人控制接口

#### 3.1 底盘控制器

```cpp
// 创建底盘控制器示例代码
#include <rmoss_gz_base/ChassisController.h>

// 需要先创建云台编码器和底盘命令模块
auto gz_gimbal_encoder = std::make_shared<rmoss_gz_base::GzJointEncoder>(
    gz_node, gz_joint_state_topic);
auto gz_chassis_cmd = std::make_shared<rmoss_gz_base::GzChassisCmd>(gz_node, gz_chassis_cmd_topic);

// 创建底盘控制器
auto chassis_controller = std::make_shared<rmoss_gz_base::ChassisController>(
    ros_node, "robot_base/chassis_cmd", gz_chassis_cmd, gz_gimbal_encoder);

// 配置底盘控制器
chassis_controller->set_chassis_pid(chassis_pid_param);  // 设置自旋PID
chassis_controller->set_control_mode(true);  // 设置跟随云台模式
```

#### 3.2 云台控制器

```cpp
// 创建云台控制器
#include <rmoss_gz_base/GimbalController.h>

auto gimbal_controller = std::make_shared<rmoss_gz_base::GimbalController>(
    ros_node, gz_node, "robot_base/gimbal_cmd", gz_gimbal_cmd_topic);

// 支持相对角控制和增量角度控制
// 同时支持获取云台当前角度，并以 ROS topic 形式发布
```

#### 3.3 射击控制器

```cpp
// 创建射击控制器
#include <rmoss_gz_base/ShooterController.h>

auto shooter_controller = std::make_shared<rmoss_gz_base::ShooterController>(
    ros_node, gz_node, "robot_base/shoot_cmd", gz_shooter_cmd_topic);
```

### 4. Gazebo 模块说明

- **GzImu**: IMU 传感器模块，提供云台 API (`get_yaw()` 和 `get_pitch()`)
- **GzJointEncoder**: 关节编码器模块，为云台增加额外 API
- **GzChassisCmd**: Gazebo 底盘指令
- **GzGimbalCmd**: Gazebo 云台指令

### 5. 传感器数据获取

```bash
# 查看可用的话题
ros2 topic list

# 查看传感器数据（示例）
ros2 topic echo /chassis_cmd
ros2 topic echo /gimbal_cmd  
ros2 topic echo /shoot_cmd
ros2 topic echo /joint_states
```

### 6. 机器人控制

#### 6.1 使用命令行直接控制

```bash
# 发送底盘控制命令
ros2 topic pub /chassis_cmd rmoss_interfaces/msg/ChassisCmd "{type: 1, twist: {linear: {x: 1.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}}"

# 发送云台控制命令
ros2 topic pub /gimbal_cmd rmoss_interfaces/msg/GimbalCmd "{position: {yaw: 0.5, pitch: 0.2}}"

# 发送射击命令
ros2 topic pub /shoot_cmd rmoss_interfaces/msg/ShootCmd "{projectile_num: 1, projectile_velocity: 20.0}"
```

#### 6.2 控制模式说明

**底盘控制模式：**
- `type: 1` - 速度控制模式
- `type: 2` - 跟随云台模式

**射击控制参数：**
- `projectile_num` - 发射弹丸数量
- `projectile_velocity` - 弹丸初速度

### 7. 仿真场景示例

#### 7.1 射击测试场景

该场景包含：
- 一个带射击器的测试方块
- 一个目标方块
- 可以测试弹丸发射和碰撞检测

启动方式：
```bash
ign gazebo src/rmoss_gazebo/rmoss_gz_plugins/test/worlds/projectile_shooter.sdf
```

#### 7.2 裁判系统测试场景

该场景包含：
- RM2021 裁判系统各个模块
- 装甲模块、指示灯模块、速度监测模块、图像传输模块

启动方式：
```bash
ign gazebo src/rmoss_gz_resources/test/rm21_referee_system.sdf
```

### 8. 完整使用流程示例

#### 8.1 启动完整仿真环境

```bash
# 终端1：启动机器人基础节点
source install/setup.bash
ros2 run rmoss_gz_base rmua19_robot_base

# 终端2：启动 Gazebo 仿真
source install/setup.bash
ign gazebo src/rmoss_gazebo/rmoss_gz_plugins/test/worlds/projectile_shooter.sdf

# 终端3：启动底盘控制
source install/setup.bash
ros2 run rmoss_gz_base test_chassis_cmd.py

# 终端4：启动云台控制
source install/setup.bash
ros2 run rmoss_gz_base test_gimbal_cmd.py

# 终端5：启动射击控制
source install/setup.bash
ros2 run rmoss_gz_base test_shoot_cmd.py
```

#### 8.2 监控系统状态

```bash
# 查看所有话题
ros2 topic list

# 监控关节状态
ros2 topic echo /joint_states

# 监控底盘命令
ros2 topic echo /chassis_cmd

# 监控云台命令
ros2 topic echo /gimbal_cmd

# 监控射击命令
ros2 topic echo /shoot_cmd
```

## 快速入门指南

### 第一次运行 - 完整步骤

如果您是第一次使用这个项目，请按照以下步骤操作：

#### 步骤1：准备环境
```bash
# 打开终端，进入工作空间
cd /data/projects/radar/simulation/ros2_simu_ws

# 加载ROS2环境
source install/setup.bash
```

#### 步骤2：启动仿真环境（3个终端）

**终端1 - 启动机器人基础节点**
```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source install/setup.bash
ros2 run rmoss_gz_base rmua19_robot_base
```

**终端2 - 启动Gazebo仿真环境**
```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source install/setup.bash
ign gazebo src/rmoss_gazebo/rmoss_gz_plugins/test/worlds/projectile_shooter.sdf
```

**终端3 - 启动底盘控制**
```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source install/setup.bash
ros2 run rmoss_gz_base test_chassis_cmd.py
```

#### 步骤3：控制机器人

在终端3中，使用以下按键控制机器人：
- `w` - 前进
- `s` - 后退
- `a` - 左移
- `d` - 右移
- `[` - 左转
- `]` - 右转
- `空格` - 停止

此时您应该能在Gazebo窗口中看到机器人移动。

### 添加更多控制功能

如果需要控制云台和射击功能，可以再启动两个终端：

**终端4 - 云台控制**
```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source install/setup.bash
ros2 run rmoss_gz_base test_gimbal_cmd.py
```

**终端5 - 射击控制**
```bash
cd /data/projects/radar/simulation/ros2_simu_ws
source install/setup.bash
ros2 run rmoss_gz_base test_shoot_cmd.py
```

## 可视化工具使用指南

### 1. Gazebo仿真界面

Gazebo启动后，您会看到以下界面元素：

#### 主窗口
- **3D视图**：显示仿真环境和机器人
- **工具栏**：包含平移、旋转、缩放等工具
- **场景面板**：显示场景中的所有模型
- **世界控制**：播放/暂停仿真，调整仿真速度

#### 常用操作
- **左键拖动**：旋转视角
- **右键拖动**：平移视角
- **滚轮**：缩放视角
- **Insert选项卡**：添加新模型到场景中

### 2. RViz2可视化工具

RViz2是ROS2的3D可视化工具，可以显示机器人状态和传感器数据：

```bash
# 启动RViz2
cd /data/projects/radar/simulation/ros2_simu_ws
source install/setup.bash
rviz2
```

#### 常用显示项
- **RobotModel**：显示机器人模型
- **TF**：显示坐标系变换
- **LaserScan**：显示激光雷达数据
- **Image**：显示相机图像
- **PointCloud2**：显示点云数据

### 3. 命令行监控工具

#### 查看话题列表
```bash
ros2 topic list
```

#### 监控机器人状态
```bash
# 查看关节状态
ros2 topic echo /joint_states

# 查看底盘命令
ros2 topic echo /chassis_cmd

# 查看云台命令
ros2 topic echo /gimbal_cmd

# 查看射击命令
ros2 topic echo /shoot_cmd
```

#### 查看节点信息
```bash
# 查看所有运行中的节点
ros2 node list

# 查看节点详细信息
ros2 node info /rmua19_robot_base
```

### 4. 图形化监控工具

#### rqt_graph - 节点关系图
```bash
rqt_graph
```
显示ROS2节点和话题之间的关系图。

#### rqt_plot - 数据绘图
```bash
rqt_plot
```
可以实时绘制话题数据图表，例如：
```
/chassis_cmd/twist/linear/x
/gimbal_cmd/position/yaw
```

## 场景和模型使用指南

### 1. 可用仿真场景

#### 射击测试场景
```bash
ign gazebo src/rmoss_gazebo/rmoss_gz_plugins/test/worlds/projectile_shooter.sdf
```
**包含内容：**
- 带射击器的测试方块
- 目标方块
- 可测试弹丸发射和碰撞检测

#### 裁判系统测试场景（RM2021）
```bash
ign gazebo src/rmoss_gz_resources/test/rm21_referee_system.sdf
```
**包含内容：**
- RM2021赛季裁判系统各模块
- 装甲板模块、指示灯模块、速度监测模块、图像传输模块

#### 裁判系统测试场景（RM2022）
```bash
ign gazebo src/rmoss_gz_resources/test/rm22_referee_system.sdf
```
**包含内容：**
- RM2022赛季裁判系统各模块
- 更新的装甲板贴纸

### 2. 可用机器人模型

#### 标准步兵机器人
```xml
<!-- 在SDF文件中引用标准机器人 -->
<include>
    <uri>model://rmua19_standard_robot</uri>
    <pose>0 0 0.15 0 0 0</pose>
</include>
```

#### 裁判系统模块
```xml
<!-- 装甲板模块 -->
<include>
    <uri>model://rm21_armor_module</uri>
    <pose>0 0 0.2 0 0 0</pose>
</include>

<!-- 指示灯模块 -->
<include>
    <uri>model://rm21_light_indicator_module</uri>
    <pose>1 0 0.2 0 0 0</pose>
</include>
```

### 3. 创建自定义场景

#### 创建简单的测试场景

1. 创建新文件：`my_test_world.sdf`
```xml
<?xml version="1.0" ?>
<sdf version="1.7">
    <world name="my_test_world">
        <!-- 基础系统插件 -->
        <plugin filename="libignition-gazebo-physics-system.so"
                name="ignition::gazebo::systems::Physics"></plugin>
        <plugin filename="libignition-gazebo-scene-broadcaster-system.so"
                name="ignition::gazebo::systems::SceneBroadcaster"></plugin>
        <plugin filename="libignition-gazebo-user-commands-system.so"
                name="ignition::gazebo::systems::UserCommands"></plugin>
        <plugin filename="libignition-gazebo-sensors-system.so"
                name="ignition::gazebo::systems::Sensors">
            <render_engine>ogre2</render_engine>
        </plugin>
        
        <!-- 光源 -->
        <light type="directional" name="sun">
            <cast_shadows>true</cast_shadows>
            <pose>0 0 10 0 0 0</pose>
            <diffuse>0.8 0.8 0.8 1</diffuse>
            <direction>-0.5 0.1 -0.9</direction>
        </light>
        
        <!-- 地面 -->
        <model name="ground_plane">
            <static>true</static>
            <link name="link">
                <collision name="collision">
                    <geometry>
                        <plane>
                            <normal>0 0 1</normal>
                            <size>100 100</size>
                        </plane>
                    </geometry>
                </collision>
                <visual name="visual">
                    <geometry>
                        <plane>
                            <normal>0 0 1</normal>
                            <size>100 100</size>
                        </plane>
                    </geometry>
                    <material>
                        <ambient>0.8 0.8 0.8 1</ambient>
                        <diffuse>0.8 0.8 0.8 1</diffuse>
                    </material>
                </visual>
            </link>
        </model>
        
        <!-- 添加机器人 -->
        <include>
            <uri>model://rmua19_standard_robot</uri>
            <pose>0 0 0.15 0 0 0</pose>
        </include>
        
        <!-- 添加障碍物 -->
        <model name="obstacle">
            <pose>2 0 0.5 0 0 0</pose>
            <link name="link">
                <collision name="collision">
                    <geometry>
                        <box>
                            <size>1 1 1</size>
                        </box>
                    </geometry>
                </collision>
                <visual name="visual">
                    <geometry>
                        <box>
                            <size>1 1 1</size>
                        </box>
                    </geometry>
                    <material>
                        <ambient>1 0 0 1</ambient>
                        <diffuse>1 0 0 1</diffuse>
                    </material>
                </visual>
            </link>
        </model>
    </world>
</sdf>
```

2. 启动自定义场景：
```bash
ign gazebo my_test_world.sdf
```

## 常见问题

### 1. 编译错误

如果遇到编译错误，请检查：
- ROS2 Humble 是否正确安装
- 所有依赖是否已安装
- Python 版本是否为 3.10+

**解决方案：**
```bash
# 重新安装依赖
rosdep update
rosdep install -y -r -q --from-paths src --ignore-src --rosdistro humble

# 清理并重新编译
cd /data/projects/radar/simulation/ros2_simu_ws
rm -rf build/ install/ log/
colcon build
```

### 2. Gazebo 启动失败

如果 Gazebo 无法启动，请检查：
- 显卡驱动是否正确安装
- Gazebo Fortress 是否正确安装
- 环境变量是否正确设置

**解决方案：**
```bash
# 检查Gazebo安装
ign gazebo --version

# 设置显卡环境变量（如果使用NVIDIA显卡）
export __GL_THREADED_OPTIMIZATIONS=1
export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:/data/projects/radar/simulation/ros2_simu_ws/src/rmoss_gz_resources/resource/models

# 尝试使用软件渲染
export LIBGL_ALWAYS_SOFTWARE=1
ign gazebo
```

### 3. 机器人模型加载失败

如果机器人模型无法加载，请检查：
- `rmoss_gz_resources` 是否正确编译
- 模型文件路径是否正确
- SDF 文件格式是否正确

**解决方案：**
```bash
# 检查模型路径
ls /data/projects/radar/simulation/ros2_simu_ws/src/rmoss_gz_resources/resource/models/

# 设置模型路径
export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:/data/projects/radar/simulation/ros2_simu_ws/src/rmoss_gz_resources/resource/models

# 重新编译资源包
colcon build --packages-select rmoss_gz_resources
```

### 4. 控制脚本无响应

如果控制脚本无法控制机器人：

**检查步骤：**
1. 确认机器人基础节点正在运行
2. 检查话题是否正确发布
3. 验证节点之间的连接

**解决方案：**
```bash
# 检查节点列表
ros2 node list

# 检查话题列表
ros2 topic list

# 检查话题数据
ros2 topic echo /chassis_cmd

# 重启所有节点
# 先停止所有节点，然后按照快速入门指南重新启动
```

### 5. 仿真性能问题

如果仿真运行缓慢：

**优化方法：**
```bash
# 降低仿真精度
ign gazebo --physics-engine real_time_update_rate=100

# 减少图形质量
export GAZEBO_RENDER_ENGINE=ogre
ign gazebo

# 关闭阴影效果
# 在Gazebo界面中：View -> Shadows
```

### 6. 网络或ROS2通信问题

如果节点之间无法通信：

**解决方案：**
```bash
# 检查ROS2环境
ros2 doctor

# 设置ROS_DOMAIN_ID（如果需要）
export ROS_DOMAIN_ID=0

# 检查防火墙设置
sudo ufw status
```

## 高级使用技巧

### 1. 自定义机器人参数

修改机器人控制参数：
```bash
# 修改底盘速度参数
ros2 run rmoss_gz_base test_chassis_cmd.py --ros-args -p v:=2.0 -p w:=1.5

# 修改云台控制参数
ros2 run rmoss_gz_base test_gimbal_cmd.py --ros-args -p step:=0.1
```

### 2. 录制和回放仿真

#### 录制仿真数据
```bash
# 创建录制目录
mkdir -p ~/gazebo_logs

# 启动录制
ign gazebo --record /path/to/world.sdf --record-path ~/gazebo_logs/
```

#### 回放仿真
```bash
ign gazebo --playback ~/gazebo_logs/state.log
```

### 3. 使用命令行直接控制

```bash
# 发送底盘控制命令
ros2 topic pub --once /chassis_cmd rmoss_interfaces/msg/ChassisCmd "{type: 1, twist: {linear: {x: 1.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}}"

# 发送云台控制命令
ros2 topic pub --once /gimbal_cmd rmoss_interfaces/msg/GimbalCmd "{position: {yaw: 0.5, pitch: 0.2}}"

# 发送射击命令
ros2 topic pub --once /shoot_cmd rmoss_interfaces/msg/ShootCmd "{projectile_num: 1, projectile_velocity: 20.0}"
```

### 4. 调试技巧

#### 查看节点连接图
```bash
rqt_graph
```

#### 监控系统资源
```bash
# 监控CPU和内存使用
htop

# 监控ROS2节点
ros2 node info /node_name
```

#### 查看详细日志
```bash
# 启动时显示详细日志
ros2 run rmoss_gz_base rmua19_robot_base --ros-args --log-level DEBUG
```

## 开发指南

### 1. 创建自定义机器人节点

参考 `Rmua19RobotBaseNode` 的实现，创建自己的机器人基础节点：

```cpp
#include <rmoss_gz_base/ChassisController.h>
#include <rmoss_gz_base/GimbalController.h>
#include <rmoss_gz_base/ShooterController.h>

class CustomRobotNode : public rclcpp::Node
{
public:
    CustomRobotNode() : Node("custom_robot_node")
    {
        // 初始化控制器
        init_controllers();
        
        // 创建定时器
        timer_ = this->create_wall_timer(
            std::chrono::milliseconds(20),
            std::bind(&CustomRobotNode::control_loop, this));
    }

private:
    void init_controllers()
    {
        // 初始化底盘、云台、射击控制器
        // 参考上面的示例代码
    }
    
    void control_loop()
    {
        // 控制循环逻辑
    }
    
    // 控制器成员变量
    std::shared_ptr<rmoss_gz_base::ChassisController> chassis_controller_;
    std::shared_ptr<rmoss_gz_base::GimbalController> gimbal_controller_;
    std::shared_ptr<rmoss_gz_base::ShooterController> shooter_controller_;
    rclcpp::Timer::SharedPtr timer_;
};
```

### 2. 添加自定义传感器

可以扩展项目添加新的传感器支持，参考现有传感器的实现模式。

## 参考资料

- [RMOSS Gazebo设计模式](https://robomaster-oss.github.io/rmoss_tutorials/#/design/rmoss_ign_design)
- [RoboMaster 官网](https://www.robomaster.com/)
- [ROS2 官方文档](https://docs.ros.org/en/humble/)
- [Gazebo 官方文档](https://gazebosim.org/docs/fortress)

## 维护者

- 维护者: Zhenpeng Ge (zhenpeng.ge@qq.com)
- 开源许可证: Apache License 2.0

## 技术支持

如遇到问题，可以：
1. 查看项目的 GitHub Issues
2. 参考 RMOSS 官方文档
3. 加入相关技术交流群讨论