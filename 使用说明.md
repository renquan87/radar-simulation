# RMUC2026 雷达仿真系统使用说明

## 概述

本仿真系统在 Ignition Gazebo (Fortress) 中模拟 RoboMaster 2026 赛场环境。

### 主要组件

- **RMUC2026 赛场地图**（STL 导入，尺寸 ~29m × 16m）
- **红蓝双方各 3 个机器人**
- **雷达站**（按规则手册 V1.3.0），搭载：
  - **Livox HAP 激光雷达**（GPU Lidar，120°×45° FOV，38400 pts/帧 @10Hz）
  - **工业相机**（1280×1024，FOV ~69°，30Hz）
- 通过 `ros_gz_bridge` 将传感器数据桥接到 ROS2 话题
- 发布完整的 TF 坐标变换树

## 环境要求

| 项目 | 版本 |
|------|------|
| 操作系统 | Ubuntu 22.04 |
| ROS2 | Humble |
| Gazebo | Ignition Fortress |
| 显卡 | 支持 OpenGL 3.3+ |

## 快速开始

### 1. 安装依赖

```bash
sudo apt-get install -y \
  ignition-fortress \
  ros-humble-ros-gz \
  ros-humble-ros-gz-bridge \
  ros-humble-ros-gz-sim \
  ros-humble-ros-gz-image \
  ros-humble-tf2-ros
```

### 2. 编译

```bash
cd /data/projects/radar/simulation/radar-simulation
source /opt/ros/humble/setup.bash
rosdep install -y -r -q --from-paths src --ignore-src --rosdistro humble
colcon build --symlink-install
source install/setup.bash
```

### 3. 一键启动

```bash
# 启动完整仿真（包含 RViz）
ros2 launch radar_sim radar_sim.launch.py

# 仅启动 Gazebo（节省资源）
ros2 launch radar_sim radar_sim.launch.py use_rviz:=false
```

## 雷达站配置（当前版本）

### 位置参数
- **世界位置**: (-14.575, 5.33, 0) - 赛场边缘，Y轴方向角落1/3处
- **雷达高度**: 2.5m（距地面）
- **相机高度**: 2.58m
- **旋转角度**: 向右旋转15°（yaw=0.262rad）
- **俯仰角**: 0°（水平放置）

### Livox HAP 传感器参数

| 参数 | 值 |
|------|-----|
| 水平 FOV | 120° |
| 垂直 FOV | 45°（已优化） |
| 探测范围 | 0.2-150m |
| 扫描频率 | 10 Hz |
| 每帧点数 | ~38,400 |

## ROS2 话题

### 传感器数据

| 话题 | 类型 | 频率 | 说明 |
|------|------|------|------|
| `/livox/lidar/points` | `sensor_msgs/PointCloud2` | 10 Hz | 激光雷达点云 |
| `/radar/camera/image` | `sensor_msgs/Image` | 30 Hz | 相机图像 |
| `/radar/camera/camera_info` | `sensor_msgs/CameraInfo` | 30 Hz | 相机内参 |

### TF 坐标变换

| 父坐标系 | 子坐标系 | 说明 |
|----------|----------|------|
| `world` | `radar_station_base` | 雷达站底座 |
| `world` | `livox_hap_lidar` | 激光雷达（简短名称） |
| `world` | `radar_camera` | 相机（简短名称） |

## 常用命令

```bash
# 查看点云频率
ros2 topic hz /livox/lidar/points

# 查看点云数据
ros2 topic echo /livox/lidar/points --once

# 查看相机图像
ros2 topic echo /radar/camera/image --once | head -10

# 查看 TF 树
ros2 run tf2_tools view_frames

# 检查 TF 变换
ros2 run tf2_ros tf2_echo world livox_hap_lidar
```

## 项目结构

```
radar-simulation/
├── src/
│   ├── radar_sim/              # 雷达仿真启动包
│   │   ├── launch/             # 启动文件
│   │   ├── rviz/               # RViz 配置
│   │   ├── worlds/             # 世界文件
│   │   └── scripts/            # 工具脚本
│   ├── rmoss_gazebo/           # Gazebo 接口
│   ├── rmoss_gz_resources/     # 模型资源
│   └── rmoss_interfaces/       # 消息定义
├── .gitattributes              # Git LFS 配置
├── .gitignore                  # Git 忽略文件
└── README.md                   # 项目说明
```

## 故障排除

### RViz 中看不到点云？
1. 检查 Fixed Frame 是否为 `world`
2. 确认话题有数据：`ros2 topic hz /livox/lidar/points`
3. 检查 TF 是否正常：`ros2 topic echo /tf_static --once`
4. 等待 8 秒让所有节点完全启动

### 点云显示不完整？
1. 确认雷达位置正确（位于赛场边缘）
2. 检查雷达是否水平放置（pitch=0）
3. 验证雷达旋转角度（yaw=0.262）

### Gazebo 启动慢？
确保有 GPU 驱动：
```bash
glxinfo | grep "OpenGL renderer"
# 应显示 GPU 型号，而非 llvmpipe
```

### EGL 警告？
正常的警告，不影响仿真。如需软件渲染：
```bash
export LIBGL_ALWAYS_SOFTWARE=1
```

## 与算法项目对接

### 对接 air_target_radar 项目

```bash
# 终端1: 启动仿真
ros2 launch radar_sim radar_sim.launch.py use_rviz:=false

# 终端2: 启动点云处理节点
ros2 launch air_target_clustering clustering.launch.py \
  lidar_topic:=/livox/lidar/points \
  use_sim_time:=true
```

### 对接 HITS-radar 项目

```bash
ros2 run pc_detector pc_detector_node \
  --ros-args \
  -p use_sim_time:=true \
  -r /livox/lidar:=/livox/lidar/points
```

## 开发者说明

### Git LFS 使用
本项目使用 Git LFS 管理大文件：
- `.stp` 文件 - CAD 模型
- `.pcd` 文件 - 点云数据
- `.dae` 文件 - 3D 模型

首次克隆后需要：
```bash
git lfs install
git lfs pull
```

### 参数调整
雷达站位置和角度可在以下文件中修改：
- `src/rmoss_gz_resources/resource/models/radar_station/model.sdf`
- `src/radar_sim/launch/radar_sim.launch.py`

修改后需要重新编译：
```bash
colcon build --packages-select radar_sim
```